<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<script>
    // Set up the SVG dimensions
    const margin = { top: 20, right: 20, bottom: 30, left: 40 };
    const width = 960 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    // Create the SVG element
    const svg = d3.select("body")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    // Load the data
    d3.csv("transformed_data/transformed_constructors.csv", (error, data) => {
        if (error) throw error;

        // Convert data to numeric values
        data.forEach(d => {
            d.points = +d.points;
            d.pointsPct = +d.pointsPct;
        });

        // Group data by year and rank
        const groupedData = d3.groups(data, d => d.year, d => d.rank);

        // Create the x and y scales
        const xScale = d3.scaleBand()
            .domain(groupedData[0][1].map(d => d.top5Name))
            .range([0, width])
            .padding(0.1);

        const yScale = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.points)])
            .range([height, 0]);

        // Create the color scale
        const colorScale = d3.scaleOrdinal()
            .domain(groupedData[0][1].map(d => d.rank))
            .range(["#d73027", "#fc8d59", "#fee090", "#e0f3f8", "#91bfdb"]);

        // Create the bars
        svg.append("g")
            .selectAll("g")
            .data(groupedData)
            .join("g")
            .attr("transform", d => `translate(${xScale(d[1][0].top5Name)},0)`)
            .selectAll("rect")
            .data(d => d[1])
            .join("rect")
            .attr("x", d => xScale(d.top5Name))
            .attr("y", d => yScale(d.points + d.pointsPct))
            .attr("height", d => yScale(d.points) - yScale(d.points + d.pointsPct))
            .attr("width", xScale.bandwidth())
            .attr("fill", d => colorScale(d.rank));

        // Create the x-axis
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale));

        // Create the y-axis
        svg.append("g")
            .call(d3.axisLeft(yScale));
    });

</script>